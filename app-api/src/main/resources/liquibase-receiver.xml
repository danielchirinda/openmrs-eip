<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog context="receiver"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
	    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet author="wluyima" id="20210202-1100">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_retry_queue"/>
            </not>
        </preConditions>
        <comment>Adding receiver_retry_queue table</comment>
        
        <createTable tableName="receiver_retry_queue">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="model_class_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_payload" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="attempt_count" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="cause_message" type="VARCHAR(1024)"/>
            <column name="message" type="VARCHAR(1024)"/>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="date_changed" type="DATETIME"/>
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20210202-1101">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_conflict_queue"/>
            </not>
        </preConditions>
        <comment>Adding receiver_conflict_queue table</comment>

        <createTable tableName="receiver_conflict_queue">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="entity_payload" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="model_class_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="is_resolved" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="wluyima" id="20210202-1050">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="site_info"/>
            </not>
        </preConditions>
        <comment>Adding site_info table</comment>

        <createTable tableName="site_info">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

 	<changeSet author="jpboane" id="20211014-1411">
        <preConditions onFail="MARK_RAN">
        	<not>
                <columnExists columnName="site_district" tableName="site_info"/>
            </not>
        </preConditions>
        <comment>Add site_district column to site_info table</comment>

        <addColumn tableName="site_info">
            <column name="site_district" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>
    
    <changeSet author="jpboane" id="20211014-1725">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="site_district" tableName="site_info" />
        </preConditions>
        <comment>Update site_district field on site_info table</comment>

        <update tableName="site_info">
            <column name="site_district"  value="AKNOWN"/>
            <where>site_district IS NULL</where>
        </update>
    </changeSet>
    
    <changeSet author="jpboane" id="20211014-1733">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="site_district" tableName="site_info" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM site_info WHERE site_district IS NULL
            </sqlCheck>
        </preConditions>
        <comment>Adding not null constraint to site_info.site_district</comment>

        <addNotNullConstraint tableName="site_info" columnName="site_district" columnDataType="VARCHAR(255)"/>
    </changeSet>
    
    <changeSet author="jpboane" id="20211014-1814">
        <preConditions onFail="MARK_RAN">
        	<not>
                <columnExists columnName="site_instance_name" tableName="site_info"/>
            </not>
        </preConditions>
        <comment>Add site_instance_name column to site_info table</comment>

        <addColumn tableName="site_info">
            <column name="site_instance_name" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>
    
    <changeSet author="jpboane" id="20211014-1816">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="site_instance_name" tableName="site_info" />
        </preConditions>
        <comment>Update site_instance_name field on site_info table</comment>

        <update tableName="site_info">
            <column name="site_instance_name"  valueComputed="name"/>
            <where>site_instance_name IS NULL</where>
        </update>
    </changeSet>
    
    <changeSet author="jpboane" id="20211014-1817">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="site_instance_name" tableName="site_info" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM site_info WHERE site_instance_name IS NULL
            </sqlCheck>
        </preConditions>
        <comment>Adding not null constraint to site_info.site_instance_name</comment>

        <addNotNullConstraint tableName="site_info" columnName="site_instance_name" columnDataType="VARCHAR(255)"/>
    </changeSet>

    <changeSet author="wluyima" id="20210202-1055">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_sync_status"/>
            </not>
        </preConditions>
        <comment>Adding receiver_sync_status table</comment>

        <createTable tableName="receiver_sync_status">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="site_info_id" type="BIGINT">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="last_sync_date" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="sync_status_site_fk"
                                 baseTableName="receiver_sync_status"
                                 baseColumnNames="site_info_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet author="wluyima" id="20210614-2101">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="exception_type" tableName="receiver_retry_queue" />
            </not>
        </preConditions>
        <comment>Add exception_type column to receiver_retry_queue table</comment>

        <addColumn tableName="receiver_retry_queue">
            <column name="exception_type" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet author="wluyima" id="20210614-2102">
        <preConditions onFail="MARK_RAN">
            <not>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(*) FROM receiver_retry_queue
                </sqlCheck>
            </not>
        </preConditions>
        <comment>Setting receiver_retry_queue.exception_type for existing rows</comment>

        <update tableName="receiver_retry_queue">
            <column name="exception_type" value="org.openmrs.eip.component.exception.EIPException" />
        </update>
    </changeSet>

    <changeSet author="wluyima" id="20210614-2103">
        <validCheckSum>8:16f10e37d5d264987862487d8cdd4bde</validCheckSum>
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="receiver_retry_queue" columnName="exception_type" />
        </preConditions>
        <comment>Adding not null constraint to receiver_retry_queue.exception_type</comment>

        <addNotNullConstraint tableName="receiver_retry_queue" columnName="exception_type" columnDataType="VARCHAR(255)" />
    </changeSet>

    <changeSet author="wluyima" id="20210601-1410">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="message" tableName="receiver_retry_queue" />
            <columnExists columnName="cause_message" tableName="receiver_retry_queue" />
            <not>
                <sqlCheck expectedResult="0">
                    SELECT COUNT(*) FROM receiver_retry_queue WHERE cause_message IS NOT NULL
                </sqlCheck>
            </not>
        </preConditions>
        <comment>Copying values from receiver_retry_queue.cause_message to receiver_retry_queue.message column</comment>

        <update tableName="receiver_retry_queue">
            <column name="message" valueComputed="cause_message" />
            <where>cause_message IS NOT NULL</where>
        </update>
    </changeSet>
    
    <changeSet author="wluyima" id="20210601-1411">
        <preConditions onFail="MARK_RAN">
            <columnExists columnName="cause_message" tableName="receiver_retry_queue" />
        </preConditions>
        <comment>Drop receiver_retry_queue.cause_message column</comment>

        <dropColumn tableName="receiver_retry_queue" columnName="cause_message" />
    </changeSet>

    <changeSet author="wluyima" id="20210825-1712">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="site_info_identifier_uk" tableName="site_info" columnNames="identifier" />
            </not>
        </preConditions>
        <comment>Add unique constraint to site_info.identifier column</comment>

        <addUniqueConstraint constraintName="site_info_identifier_uk" tableName="site_info" columnNames="identifier" />
    </changeSet>

    <changeSet author="wluyima" id="20210825-1713">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists indexName="site_info_name_uk" tableName="site_info" columnNames="name" />
            </not>
        </preConditions>
        <comment>Add unique constraint to site_info.name column</comment>

        <addUniqueConstraint constraintName="site_info_name_uk" tableName="site_info" columnNames="name" />
    </changeSet>

    <changeSet author="wluyima" id="20210827-1302">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_sync_msg"/>
            </not>
        </preConditions>
        <comment>Adding receiver_sync_msg table</comment>

        <createTable tableName="receiver_sync_msg">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="model_class_name" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="entity_payload" type="TEXT">
                <constraints nullable="false" />
            </column>
            <column name="site_id" type="BIGINT">
                <constraints nullable="false" />
            </column>
            <column name="date_created" type="TIMESTAMP">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint constraintName="sync_msg_site_fk"
                                 baseTableName="receiver_sync_msg"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet author="wluyima" id="20211111-1400">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="site_id" tableName="receiver_retry_queue" />
            </not>
        </preConditions>
        <comment>Add site_id column to receiver_retry_queue table</comment>

        <addColumn tableName="receiver_retry_queue">
            <column name="site_id" type="BIGINT" />
        </addColumn>

        <addForeignKeyConstraint constraintName="receiver_retry_queue_site_fk"
                                 baseTableName="receiver_retry_queue"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet author="wluyima" id="20211111-1401">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists columnName="site_id" tableName="receiver_conflict_queue" />
            </not>
        </preConditions>
        <comment>Add site_id column to receiver_conflict_queue table</comment>

        <addColumn tableName="receiver_conflict_queue">
            <column name="site_id" type="BIGINT" />
        </addColumn>

        <addForeignKeyConstraint constraintName="receiver_conflict_queue_site_fk"
                                 baseTableName="receiver_conflict_queue"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet author="wluyima" id="20211208-1400">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="receiver_sync_request" />
            </not>
        </preConditions>
        <comment>Adding receiver_sync_request table</comment>

        <createTable tableName="receiver_sync_request">
            <column autoIncrement="true" name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="table_name" type="VARCHAR(100)">
                <constraints nullable="false" />
            </column>
            <column name="identifier" type="VARCHAR(255)">
                <constraints nullable="false" />
            </column>
            <column name="site_id" type="BIGINT" />
            <column name="status" type="VARCHAR(50)" defaultValue="NEW" />
            <column name="found" type="BOOLEAN" defaultValueBoolean="false">
                <constraints nullable="false" />
            </column>
            <column name="request_uuid" type="VARCHAR(38)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="date_created" type="DATETIME">
                <constraints nullable="false" />
            </column>
            <column name="date_received" type="DATETIME" />
            <column name="date_sent" type="DATETIME" />
        </createTable>

        <addForeignKeyConstraint constraintName="receiver_sync_request_site_fk"
                                 baseTableName="receiver_sync_request"
                                 baseColumnNames="site_id"
                                 referencedTableName="site_info"
                                 referencedColumnNames="id" />
    </changeSet>

</databaseChangeLog>
